/*! asmsimulator 18-03-2020 */

var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(g){return{go:function(e){for(var t=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9\+]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9\+]\w*))?)?)?/,o=/^[-+]?[0-9]+$/,r=/^[.A-Za-z]\w*$/,a=[],s={},n={},i={},d=e.split("\n"),p=function(e,t,r){var a=l(e);if(void 0!==a)return{type:r,value:a};var s=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(o.exec(e))return parseInt(e,10);throw"Invalid number format"}(e);if(isNaN(s))throw"Not a "+r+": "+s;if(s<0||255<s)throw r+" must have a value between 0-255";return{type:r,value:s}},l=function(e){return r.exec(e)?e:void 0},c=function(e){switch(e.slice(0,1)){case"[":var t=e.slice(1,e.length-1);return p(t,0,"address");case'"':for(var r=e.slice(1,e.length-1),a=[],s=0,o=r.length;s<o;s++)a.push(r.charCodeAt(s));return{type:"numbers",value:a};case"'":var n=e.slice(1,e.length-1);if(1<n.length)throw"Only one character is allowed. Use String instead";return{type:"number",value:n.charCodeAt(0)};default:return p(e,0,"number")}},u=function(e){if(e.toUpperCase()in i)throw"Duplicate label: "+e;n[e]=a.length},S=function(e,t){if(void 0!==t)throw e+": too many arguments"},D=0,h=d.length;D<h;D++)try{var f=t.exec(d[D]);if(void 0!==f[1]||void 0!==f[2]){if(void 0!==f[1]&&u(f[1]),void 0!==f[2]){var _,m,R,v=f[2].toUpperCase();switch("DB"!==v&&(s[a.length]=D),v){case"DB":if("number"===(_=c(f[3])).type)a.push(_.value);else{if("numbers"!==_.type)throw"DB does not support this operand";for(var E=0,A=_.value.length;E<A;E++)a.push(_.value[E])}break;case"CP":if(_=c(f[3]),m=c(f[7]),"address"===_.type&&"number"===m.type)R=g.CP_NUMBER_TO_ADDRESS;else{if("address"!==_.type||"address"!==m.type)throw"CP does not support this operands";R=g.CP_ADDRESS_TO_ADDRESS}a.push(R,_.value,m.value);break;case"CTP":if(_=c(f[3]),m=c(f[7]),"address"===_.type&&"number"===m.type)R=g.CTP_NUMBER_TO_ADDRESS;else{if("address"!==_.type||"address"!==m.type)throw"CTP does not support this operands";R=g.CTP_ADDRESS_TO_ADDRESS}a.push(R,_.value,m.value);break;case"CFP":if(_=c(f[3]),m=c(f[7]),"address"!==_.type||"address"!==m.type)throw"CFP does not support this operands";R=g.CFP_ADDRESS_TO_ADDRESS,a.push(R,_.value,m.value);break;case"ADD":if(_=c(f[3]),m=c(f[7]),"address"===_.type&&"address"===m.type)R=g.ADD_ADDRESS_TO_ADDRESS;else{if("address"!==_.type||"number"!==m.type)throw"ADD does not support this operands";R=g.ADD_NUMBER_TO_ADDRESS}a.push(R,_.value,m.value);break;case"SUB":if(_=c(f[3]),m=c(f[7]),"address"===_.type&&"address"===m.type)R=g.SUB_ADDRESS_FROM_ADDRESS;else{if("address"!==_.type||"number"!==m.type)throw"SUB does not support this operands";R=g.SUB_NUMBER_FROM_ADDRESS}a.push(R,_.value,m.value);break;case"INC":if(_=c(f[3]),S("INC",f[7]),"address"!==_.type)throw"INC does not support this operand";R=g.INC_ADDRESS,a.push(R,_.value);break;case"DEC":if(_=c(f[3]),S("DEC",f[7]),"address"!==_.type)throw"DEC does not support this operand";R=g.DEC_ADDRESS,a.push(R,_.value);break;case"CMP":if(_=c(f[3]),m=c(f[7]),"address"===_.type&&"address"===m.type)R=g.CMP_ADDRESS_WITH_ADDRESS;else{if("address"!==_.type||"number"!==m.type)throw"CMP does not support this operands";R=g.CMP_NUMBER_WITH_ADDRESS}a.push(R,_.value,m.value);break;case"JP":if(_=c(f[3]),S("JP",f[7]),"number"!==_.type)throw"JP does not support this operands";R=g.JP_ADDRESS,a.push(R,_.value);break;case"JO":if(_=c(f[3]),S(v,f[7]),"number"!==_.type)throw v+" does not support this operand";R=g.JC_ADDRESS,a.push(R,_.value);break;case"JZ":if(_=c(f[3]),S(v,f[7]),"number"!==_.type)throw v+" does not support this operand";R=g.JZ_ADDRESS,a.push(R,_.value);break;case"PRND":if(_=c(f[3]),S(v,f[7]),"address"!==_.type)throw v+" does not support this operand";R=g.PRINT_DECIMAL,a.push(R,_.value);break;case"PRNS":if(_=c(f[3]),S(v,f[7]),"address"!==_.type)throw v+" does not support this operand";R=g.PRINT_STRING,a.push(R,_.value);break;default:throw"Invalid instruction: "+f[2]}}}else{var b=d[D].trim();if(""!==b&&";"!==b.slice(0,1))throw"Syntax error"}}catch(e){throw{error:e,line:D}}for(D=0,h=a.length;D<h;D++)if(!angular.isNumber(a[D])){if(!(a[D]in n))throw{error:"Undefined label: "+a[D]};a[D]=n[a[D]]}return{code:a,mapping:s,labels:n}}}}]),app.service("cpu",["opcodes","memory",function(i,d){var e={step:function(){var t=this;if(!0===t.fault)throw"FAULT. Reset to continue.";try{var e,r,a,s=function(e){return t.zero=!1,t.carry=!1,256<=e?(t.carry=!0,e%=256):0===e?t.zero=!0:e<0&&(t.carry=!0,e=256- -e%256),e},o=function(e){if(e<0||e>=d.data.length)throw"IP outside memory";t.ip=e};if(t.ip<0||t.ip>=d.data.length)throw"Instruction pointer is outside of memory";var n=d.load(t.ip);switch(n){case i.NONE:return!1;case i.CP_NUMBER_TO_ADDRESS:r=d.load(++t.ip),a=d.load(++t.ip),d.store(r,a),t.ip++;break;case i.CP_ADDRESS_TO_ADDRESS:r=d.load(++t.ip),e=d.load(d.load(++t.ip)),d.store(r,e),t.ip++;break;case i.CTP_ADDRESS_TO_ADDRESS:addrTo=d.load(d.load(++t.ip)),e=d.load(d.load(++t.ip)),d.store(addrTo,e),t.ip++;break;case i.CTP_NUMBER_TO_ADDRESS:addrTo=d.load(d.load(++t.ip)),a=d.load(++t.ip),d.store(addrTo,a),t.ip++;break;case i.CFP_ADDRESS_TO_ADDRESS:r=d.load(++t.ip),addrFrom=d.load(d.load(d.load(++t.ip))),d.store(r,addrFrom),t.ip++;break;case i.ADD_NUMBER_TO_ADDRESS:r=d.load(++t.ip),srcNum=d.load(r),a=d.load(++t.ip),d.store(r,srcNum+a),t.ip++;break;case i.ADD_ADDRESS_TO_ADDRESS:r=d.load(++t.ip),e=d.load(++t.ip),srcNum=d.load(r),srcNum1=d.load(e),d.store(r,srcNum+srcNum1),t.ip++;break;case i.SUB_NUMBER_FROM_ADDRESS:r=d.load(++t.ip),destNum=d.load(r),a=d.load(++t.ip),d.store(r,s(destNum-a)),t.ip++;break;case i.SUB_ADDRESS_FROM_ADDRESS:r=d.load(++t.ip),e=d.load(++t.ip),number1=d.load(r),number2=d.load(e),d.store(r,s(number1-number2)),t.ip++;break;case i.INC_ADDRESS:r=d.load(++t.ip),a=d.load(r),d.store(r,s(++a)),t.ip++;break;case i.DEC_ADDRESS:r=d.load(++t.ip),a=d.load(r),d.store(r,s(--a)),t.ip++;break;case i.CMP_ADDRESS_WITH_ADDRESS:r=d.load(++t.ip),e=d.load(++t.ip),number1=d.load(r),number2=d.load(e),s(number1-number2),t.ip++;break;case i.CMP_NUMBER_WITH_ADDRESS:r=d.load(++t.ip),number1=d.load(r),number2=d.load(++t.ip),s(number1-number2),t.ip++;break;case i.JP_ADDRESS:o(a=d.load(++t.ip));break;case i.JC_ADDRESS:a=d.load(++t.ip),t.carry?o(a):t.ip++;break;case i.JZ_ADDRESS:a=d.load(++t.ip),t.zero?o(a):t.ip++;break;case i.PRINT_DECIMAL:addressFrom=d.load(++t.ip),a=d.load(addressFrom),addressTo=t.sp+1,d.clear(addressTo,23),d.copyString(addressTo,a.toString()),t.ip++;break;case i.PRINT_STRING:for(addressFrom=d.load(++t.ip),addressTo=t.sp+1,d.clear(addressTo,23),count=0,addr=addressFrom,value=d.load(addr++);count<24&&0<value;)++count,value=d.load(addr++);d.copy(addressTo,addressFrom,count),t.ip++;break;default:throw"Invalid op code: "+n}return!0}catch(e){throw t.fault=!0,e}},reset:function(){var e=this;e.maxSP=231,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return e.reset(),e}]),app.service("memory",[function(){var e={data:Array(256),lastAccess:-1,load:function(e){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,this.data[e]},store:function(e,t){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=t},clear:function(e,t){if(e<0||e>=this.data.length||e+t>=this.data.length)throw"Memory access violation at "+e;for(i=0;i<t;++i)this.data[e+i]=0;this.lastAccess=e+t},copy:function(e,t,r){var a=this;if(e<0||e>=a.data.length||e+r>=a.data.length)throw"Memory access violation at "+e;if(t<0||t>=a.data.length||t+r>=a.data.length)throw"Memory access violation at "+t;if(e<t&&t<e+r)throw"Memory access violation at "+e;for(i=0;i<r;++i)a.data[e+i]=a.data[t+i];a.lastAccess=e+r},copyString:function(e,t){var r=t.length;if(e<0||e>=this.data.length||e+r>=this.data.length)throw"Memory access violation at "+e;for(i=0;i<r;++i){var a=t.substr(i,1);"-"===a?a=45:("0"<=a||a<="9")&&(a=parseInt(a,10)+48),console.log(a),this.data[e+i]=a}this.lastAccess=e+r},reset:function(){this.lastAccess=-1;for(var e=0,t=this.data.length;e<t;e++)this.data[e]=0}};return e.reset(),e}]),app.service("opcodes",[function(){return{NONE:0,CP_ADDRESS_TO_ADDRESS:1,CP_NUMBER_TO_ADDRESS:2,ADD_ADDRESS_TO_ADDRESS:3,ADD_NUMBER_TO_ADDRESS:4,SUB_ADDRESS_FROM_ADDRESS:5,SUB_NUMBER_FROM_ADDRESS:6,INC_ADDRESS:7,DEC_ADDRESS:8,CMP_ADDRESS_WITH_ADDRESS:9,CMP_NUMBER_WITH_ADDRESS:10,JP_ADDRESS:11,JC_ADDRESS:12,JZ_ADDRESS:13,PRINT_STRING:14,PRINT_DECIMAL:15,CFP_ADDRESS_TO_ADDRESS:16,CTP_NUMBER_TO_ADDRESS:17,CTP_ADDRESS_TO_ADDRESS:18}}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(t,s,e,r,o,n){var a;s.memory=o,s.cpu=r,s.error="",s.isRunning=!1,s.displayHex=!0,s.displayInstr=!0,s.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],s.speed=16,s.outputStartIndex=232,s.code="; Simple example\n;for (char i = 0; i < 50; ++i)\njp loop\ni: db 0             ;char i = 0;\nloop: cmp [i], 50   ;check i against 50\njz end              ;goto end if i==50\ninc [i]             ;i++\njp loop             ;goto loop\nend:\n",s.reset=function(){r.reset(),o.reset(),s.error="",s.selectedLine=-1},s.executeStep=function(){s.checkPrgrmLoaded()||s.assemble();try{var e=r.step();return r.ip in s.mapping&&(s.selectedLine=s.mapping[r.ip]),e}catch(e){return s.error=e,!1}},s.run=function(){s.checkPrgrmLoaded()||s.assemble(),s.isRunning=!0,a=e(function(){!0===s.executeStep()?s.run():s.isRunning=!1},1e3/s.speed)},s.stop=function(){e.cancel(a),s.isRunning=!1},s.checkPrgrmLoaded=function(){for(var e=0,t=o.data.length;e<t;e++)if(0!==o.data[e])return!0;return!1},s.getChar=function(e){var t=String.fromCharCode(e);return""===t.trim()?"  ":t},s.assemble=function(){try{s.reset();var e=n.go(s.code);s.mapping=e.mapping;var t=e.code;if(s.labels=e.labels,t.length>o.data.length)throw"Binary code does not fit into the memory. Max "+o.data.length+" bytes are allowed";for(var r=0,a=t.length;r<a;r++)o.data[r]=t[r]}catch(e){void 0!==e.line?(s.error=e.line+" | "+e.error,s.selectedLine=e.line):s.error=e.error}},s.jumpToLine=function(e){t[0].getElementById("sourceCode").scrollIntoView(),s.selectedLine=s.mapping[e]},s.isInstruction=function(e){return void 0!==s.mapping&&void 0!==s.mapping[e]&&s.displayInstr},s.getMemoryCellCss=function(e){return e>=s.outputStartIndex?"output-bg":s.isInstruction(e)?"instr-bg":""},s.getMemoryInnerCellCss=function(e){return e===r.ip?"marker marker-ip":""}}]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.filter("number",function(){return function(e,t){if(t){var r=e.toString(16).toUpperCase();return 1==r.length?"0"+r:r}return e.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(o,n,e,t){o.$watch("selectedLine",function(){if(0<=o.selectedLine){for(var e=n[0].value.split("\n"),t=0,r=0;r<e.length&&r!=o.selectedLine;r++)t+=e[r].length+1;var a=e[o.selectedLine].length+t;if(void 0!==n[0].selectionStart&&(n[0].focus(),n[0].selectionStart=t,n[0].selectionEnd=a),document.selection&&document.selection.createRange){n[0].focus(),n[0].select();var s=document.selection.createRange();s.collapse(!0),s.moveEnd("character",a),s.moveStart("character",t),s.select()}}})}}}]),app.filter("startFrom",function(){return function(e,t){return t=+t,e.slice(t)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,t,r,a){t.bind("keydown",function(e){if(9===e.keyCode){var t=this.value,r=this.selectionStart,a=this.selectionEnd;return this.value=t.substring(0,r)+"\t"+t.substring(a),this.selectionStart=this.selectionEnd=r+1,e.preventDefault(),!1}})}}}]);