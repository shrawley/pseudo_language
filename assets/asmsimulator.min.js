/*! asmsimulator 10-05-2021 */

var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(b){return{go:function(e){function i(e,t,r){var a=u(e);if(void 0!==a)return{type:r,value:a};var s=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(o.exec(e))return parseInt(e,10);throw"Invalid number format"}(e);if(isNaN(s))throw"Not a "+r+": "+s;if(s<0||255<s)throw r+" must have a value between 0-255";return{type:r,value:s}}function t(e){switch(e.slice(0,1)){case"[":var t=e.slice(1,e.length-1);return i(t,0,"address");case'"':for(var r=e.slice(1,e.length-1),a=[],s=0,o=r.length;s<o;s++)a.push(r.charCodeAt(s));return{type:"numbers",value:a};case"'":var n=e.slice(1,e.length-1);if(1<n.length)throw"Only one character is allowed. Use String instead";return{type:"number",value:n.charCodeAt(0)};default:return i(e,0,"number")}}function r(e,t){if(void 0!==t)throw e+": too many arguments"}for(var a=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9\+]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9\+]\w*))?)?)?/,o=/^[-+]?[0-9]+$/,s=/^[.A-Za-z]\w*$/,n=[],d={},p={},l={},c=e.split("\n"),u=function(e){return s.exec(e)?e:void 0},S=0,D=c.length;S<D;S++)try{var h=a.exec(c[S]);if(void 0!==h[1]||void 0!==h[2]){if(void 0!==h[1]&&function(e){if(e.toUpperCase()in l)throw"Duplicate label: "+e;p[e]=n.length}(h[1]),void 0!==h[2]){var f,_,m,R=h[2].toUpperCase();switch("DB"!==R&&(d[n.length]=S),R){case"DB":if("number"===(f=t(h[3])).type)n.push(f.value);else{if("numbers"!==f.type)throw"DB does not support this operand";for(var E=0,v=f.value.length;E<v;E++)n.push(f.value[E])}break;case"CP":if(f=t(h[3]),_=t(h[7]),"address"===f.type&&"number"===_.type)m=b.CP_NUMBER_TO_ADDRESS;else{if("address"!==f.type||"address"!==_.type)throw"CP does not support this operands";m=b.CP_ADDRESS_TO_ADDRESS}n.push(m,f.value,_.value);break;case"CTP":if(f=t(h[3]),_=t(h[7]),"address"===f.type&&"number"===_.type)m=b.CTP_NUMBER_TO_ADDRESS;else{if("address"!==f.type||"address"!==_.type)throw"CTP does not support this operands";m=b.CTP_ADDRESS_TO_ADDRESS}n.push(m,f.value,_.value);break;case"CFP":if(f=t(h[3]),_=t(h[7]),"address"!==f.type||"address"!==_.type)throw"CFP does not support this operands";m=b.CFP_ADDRESS_TO_ADDRESS,n.push(m,f.value,_.value);break;case"ADD":if(f=t(h[3]),_=t(h[7]),"address"===f.type&&"address"===_.type)m=b.ADD_ADDRESS_TO_ADDRESS;else{if("address"!==f.type||"number"!==_.type)throw"ADD does not support this operands";m=b.ADD_NUMBER_TO_ADDRESS}n.push(m,f.value,_.value);break;case"SUB":if(f=t(h[3]),_=t(h[7]),"address"===f.type&&"address"===_.type)m=b.SUB_ADDRESS_FROM_ADDRESS;else{if("address"!==f.type||"number"!==_.type)throw"SUB does not support this operands";m=b.SUB_NUMBER_FROM_ADDRESS}n.push(m,f.value,_.value);break;case"INC":if(f=t(h[3]),r("INC",h[7]),"address"!==f.type)throw"INC does not support this operand";m=b.INC_ADDRESS,n.push(m,f.value);break;case"DEC":if(f=t(h[3]),r("DEC",h[7]),"address"!==f.type)throw"DEC does not support this operand";m=b.DEC_ADDRESS,n.push(m,f.value);break;case"CMP":if(f=t(h[3]),_=t(h[7]),"address"===f.type&&"address"===_.type)m=b.CMP_ADDRESS_WITH_ADDRESS;else{if("address"!==f.type||"number"!==_.type)throw"CMP does not support this operands";m=b.CMP_NUMBER_WITH_ADDRESS}n.push(m,f.value,_.value);break;case"JP":if(f=t(h[3]),r("JP",h[7]),"number"!==f.type)throw"JP does not support this operands";m=b.JP_ADDRESS,n.push(m,f.value);break;case"JO":if(f=t(h[3]),r(R,h[7]),"number"!==f.type)throw R+" does not support this operand";m=b.JC_ADDRESS,n.push(m,f.value);break;case"JZ":if(f=t(h[3]),r(R,h[7]),"number"!==f.type)throw R+" does not support this operand";m=b.JZ_ADDRESS,n.push(m,f.value);break;case"PRND":if(f=t(h[3]),r(R,h[7]),"address"!==f.type)throw R+" does not support this operand";m=b.PRINT_DECIMAL,n.push(m,f.value);break;case"PRNS":if(f=t(h[3]),r(R,h[7]),"address"!==f.type)throw R+" does not support this operand";m=b.PRINT_STRING,n.push(m,f.value);break;default:throw"Invalid instruction: "+h[2]}}}else{var A=c[S].trim();if(""!==A&&";"!==A.slice(0,1))throw"Syntax error"}}catch(e){throw{error:e,line:S}}for(S=0,D=n.length;S<D;S++)if(!angular.isNumber(n[S])){if(!(n[S]in p))throw{error:"Undefined label: "+n[S]};n[S]=p[n[S]]}return{code:n,mapping:d,labels:p}}}}]),app.service("cpu",["opcodes","memory",function(i,d){var e={step:function(){var t=this;if(!0===t.fault)throw"FAULT. Reset to continue.";try{function e(e){return t.zero=!1,t.carry=!1,256<=e?(t.carry=!0,e%=256):0===e?t.zero=!0:e<0&&(t.carry=!0,e=256- -e%256),e}function r(e){if(e<0||e>=d.data.length)throw"IP outside memory";t.ip=e}var a,s,o;if(t.ip<0||t.ip>=d.data.length)throw"Instruction pointer is outside of memory";var n=d.load(t.ip);switch(n){case i.NONE:return!1;case i.CP_NUMBER_TO_ADDRESS:s=d.load(++t.ip),o=d.load(++t.ip),d.store(s,o),t.ip++;break;case i.CP_ADDRESS_TO_ADDRESS:s=d.load(++t.ip),a=d.load(d.load(++t.ip)),d.store(s,a),t.ip++;break;case i.CTP_ADDRESS_TO_ADDRESS:addrTo=d.load(d.load(++t.ip)),a=d.load(d.load(++t.ip)),d.store(addrTo,a),t.ip++;break;case i.CTP_NUMBER_TO_ADDRESS:addrTo=d.load(d.load(++t.ip)),o=d.load(++t.ip),d.store(addrTo,o),t.ip++;break;case i.CFP_ADDRESS_TO_ADDRESS:s=d.load(++t.ip),addrFrom=d.load(d.load(d.load(++t.ip))),d.store(s,addrFrom),t.ip++;break;case i.ADD_NUMBER_TO_ADDRESS:s=d.load(++t.ip),srcNum=d.load(s),o=d.load(++t.ip),d.store(s,srcNum+o),t.ip++;break;case i.ADD_ADDRESS_TO_ADDRESS:s=d.load(++t.ip),a=d.load(++t.ip),srcNum=d.load(s),srcNum1=d.load(a),d.store(s,srcNum+srcNum1),t.ip++;break;case i.SUB_NUMBER_FROM_ADDRESS:s=d.load(++t.ip),destNum=d.load(s),o=d.load(++t.ip),d.store(s,e(destNum-o)),t.ip++;break;case i.SUB_ADDRESS_FROM_ADDRESS:s=d.load(++t.ip),a=d.load(++t.ip),number1=d.load(s),number2=d.load(a),d.store(s,e(number1-number2)),t.ip++;break;case i.INC_ADDRESS:s=d.load(++t.ip),o=d.load(s),d.store(s,e(++o)),t.ip++;break;case i.DEC_ADDRESS:s=d.load(++t.ip),o=d.load(s),d.store(s,e(--o)),t.ip++;break;case i.CMP_ADDRESS_WITH_ADDRESS:s=d.load(++t.ip),a=d.load(++t.ip),number1=d.load(s),number2=d.load(a),e(number1-number2),t.ip++;break;case i.CMP_NUMBER_WITH_ADDRESS:s=d.load(++t.ip),number1=d.load(s),number2=d.load(++t.ip),e(number1-number2),t.ip++;break;case i.JP_ADDRESS:r(o=d.load(++t.ip));break;case i.JC_ADDRESS:o=d.load(++t.ip),t.carry?r(o):t.ip++;break;case i.JZ_ADDRESS:o=d.load(++t.ip),t.zero?r(o):t.ip++;break;case i.PRINT_DECIMAL:addressFrom=d.load(++t.ip),o=d.load(addressFrom),addressTo=t.sp+1,d.clear(addressTo,23),d.copyString(addressTo,o.toString()),t.ip++;break;case i.PRINT_STRING:for(addressFrom=d.load(++t.ip),addressTo=t.sp+1,d.clear(addressTo,23),count=0,addr=addressFrom,value=d.load(addr++);count<24&&0<value;)++count,value=d.load(addr++);d.copy(addressTo,addressFrom,count),t.ip++;break;default:throw"Invalid op code: "+n}return!0}catch(e){throw t.fault=!0,e}},reset:function(){var e=this;e.maxSP=231,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return e.reset(),e}]),app.service("memory",[function(){var e={data:Array(256),lastAccess:-1,load:function(e){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,this.data[e]},store:function(e,t){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=t},clear:function(e,t){if(e<0||e>=this.data.length||e+t>=this.data.length)throw"Memory access violation at "+e;for(i=0;i<t;++i)this.data[e+i]=0;this.lastAccess=e+t},copy:function(e,t,r){var a=this;if(e<0||e>=a.data.length||e+r>=a.data.length)throw"Memory access violation at "+e;if(t<0||t>=a.data.length||t+r>=a.data.length)throw"Memory access violation at "+t;if(e<t&&t<e+r)throw"Memory access violation at "+e;for(i=0;i<r;++i)a.data[e+i]=a.data[t+i];a.lastAccess=e+r},copyString:function(e,t){var r=t.length;if(e<0||e>=this.data.length||e+r>=this.data.length)throw"Memory access violation at "+e;for(i=0;i<r;++i){var a=t.substr(i,1);"-"===a?a=45:("0"<=a||a<="9")&&(a=parseInt(a,10)+48),console.log(a),this.data[e+i]=a}this.lastAccess=e+r},reset:function(){this.lastAccess=-1;for(var e=0,t=this.data.length;e<t;e++)this.data[e]=0}};return e.reset(),e}]),app.service("opcodes",[function(){return{NONE:0,CP_ADDRESS_TO_ADDRESS:1,CP_NUMBER_TO_ADDRESS:2,ADD_ADDRESS_TO_ADDRESS:3,ADD_NUMBER_TO_ADDRESS:4,SUB_ADDRESS_FROM_ADDRESS:5,SUB_NUMBER_FROM_ADDRESS:6,INC_ADDRESS:7,DEC_ADDRESS:8,CMP_ADDRESS_WITH_ADDRESS:9,CMP_NUMBER_WITH_ADDRESS:10,JP_ADDRESS:11,JC_ADDRESS:12,JZ_ADDRESS:13,PRINT_STRING:14,PRINT_DECIMAL:15,CFP_ADDRESS_TO_ADDRESS:16,CTP_NUMBER_TO_ADDRESS:17,CTP_ADDRESS_TO_ADDRESS:18}}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(t,s,e,r,o,n){var a;s.memory=o,s.cpu=r,s.error="",s.isRunning=!1,s.displayHex=!0,s.displayInstr=!0,s.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],s.speed=16,s.outputStartIndex=232,s.code="; Simple example\n;for (char i = 0; i < 50; ++i)\njp loop\ni: db 0             ;char i = 0;\nloop: cmp [i], 50   ;check i against 50\njz end              ;goto end if i==50\ninc [i]             ;i++\njp loop             ;goto loop\nend:\n",s.reset=function(){r.reset(),o.reset(),s.error="",s.selectedLine=-1},s.executeStep=function(){s.checkPrgrmLoaded()||s.assemble();try{var e=r.step();return r.ip in s.mapping&&(s.selectedLine=s.mapping[r.ip]),e}catch(e){return s.error=e,!1}},s.run=function(){s.checkPrgrmLoaded()||s.assemble(),s.isRunning=!0,a=e(function(){!0===s.executeStep()?s.run():s.isRunning=!1},1e3/s.speed)},s.stop=function(){e.cancel(a),s.isRunning=!1},s.checkPrgrmLoaded=function(){for(var e=0,t=o.data.length;e<t;e++)if(0!==o.data[e])return!0;return!1},s.getChar=function(e){var t=String.fromCharCode(e);return""===t.trim()?"  ":t},s.assemble=function(){try{s.reset();var e=n.go(s.code);s.mapping=e.mapping;var t=e.code;if(s.labels=e.labels,t.length>o.data.length)throw"Binary code does not fit into the memory. Max "+o.data.length+" bytes are allowed";for(var r=0,a=t.length;r<a;r++)o.data[r]=t[r]}catch(e){void 0!==e.line?(s.error=e.line+" | "+e.error,s.selectedLine=e.line):s.error=e.error}},s.jumpToLine=function(e){t[0].getElementById("sourceCode").scrollIntoView(),s.selectedLine=s.mapping[e]},s.isInstruction=function(e){return void 0!==s.mapping&&void 0!==s.mapping[e]&&s.displayInstr},s.getMemoryCellCss=function(e){return e>=s.outputStartIndex?"output-bg":s.isInstruction(e)?"instr-bg":""},s.getMemoryInnerCellCss=function(e){return e===r.ip?"marker marker-ip":""}}]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.filter("number",function(){return function(e,t){if(t){var r=e.toString(16).toUpperCase();return 1==r.length?"0"+r:r}return e.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(o,n,e,t){o.$watch("selectedLine",function(){if(0<=o.selectedLine){for(var e=n[0].value.split("\n"),t=0,r=0;r<e.length&&r!=o.selectedLine;r++)t+=e[r].length+1;var a,s=e[o.selectedLine].length+t;void 0!==n[0].selectionStart&&(n[0].focus(),n[0].selectionStart=t,n[0].selectionEnd=s),document.selection&&document.selection.createRange&&(n[0].focus(),n[0].select(),(a=document.selection.createRange()).collapse(!0),a.moveEnd("character",s),a.moveStart("character",t),a.select())}})}}}]),app.filter("startFrom",function(){return function(e,t){return t=+t,e.slice(t)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,t,r,a){t.bind("keydown",function(e){if(9===e.keyCode){var t=this.value,r=this.selectionStart,a=this.selectionEnd;return this.value=t.substring(0,r)+"\t"+t.substring(a),this.selectionStart=this.selectionEnd=r+1,e.preventDefault(),!1}})}}}]);